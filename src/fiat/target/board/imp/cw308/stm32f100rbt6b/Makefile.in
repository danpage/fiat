# Copyright (C) 2024 Daniel Page <dan@phoo.org>
#
# Use of this source code is restricted per the MIT license, a copy of which 
# can be found via https://opensource.org/license/mit (and which is included 
# as LICENSE.txt within the associated archive or repository).

# =============================================================================

INCLUDES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal
INCLUDES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1
INCLUDES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/CMSIS
INCLUDES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/CMSIS/core
INCLUDES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/CMSIS/device
INCLUDES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/Legacy

 SOURCES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/stm32f1_startup.S
 SOURCES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/stm32f1_hal.c 
 SOURCES   += ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/stm32f1_hal_lowlevel.c 

 TARGETS   += ${FIAT_BUILD}/target/${FIAT_BOARD}/target.elf 
 TARGETS   += ${FIAT_BUILD}/target/${FIAT_BOARD}/target.bin 
 TARGETS   += ${FIAT_BUILD}/target/${FIAT_BOARD}/target.hex

GCC_PREFIX  = arm-none-eabi-

# 1.  option-related => class 1: architecture
GCC_FLAGS  += -mcpu="cortex-m3" -mthumb -mfloat-abi="soft" 
# 1.  option-related => class 2: compiler
GCC_FLAGS  += -Os -Wall -std="gnu11" -ffreestanding -funsigned-char -funsigned-bitfields -fshort-enums -fvisibility="hidden" -ffunction-sections
# 1.  option-related => class 3:   linker
GCC_FLAGS  += -T ${FIAT_DEPS}/chipwhisperer/firmware/mcu/hal/chipwhisperer-fw-extra/stm32f1/LinkerScript.ld --specs="nano.specs" --specs="nosys.specs" 
# 1.  option-related => class 4: configuration (of HAL, BSP, etc.)
GCC_FLAGS  += -DPLATFORM="CW308_STM32F1" -DHAL_TYPE="HAL_stm32f1" -DSS_VER="1" -DSTM32 -DSTM32F1 -DSTM32F100xB -DF_CPU="7372800UL"
# 2.    path-related
GCC_PATHS  +=
# 3. library-related
GCC_LIBS   += -lm 

# -----------------------------------------------------------------------------

fetch-deps :
	@git clone https://github.com/newaetech/chipwhisperer.git ${FIAT_DEPS}/chipwhisperer
	@git -C ${FIAT_DEPS}/chipwhisperer checkout d38eae52080fab801624e905046a5ee042da560f
	@git -C ${FIAT_DEPS}/chipwhisperer submodule update --init --recursive

patch-deps :

build-deps :

clean-deps : 
	@rm --force --recursive ${FIAT_DEPS}

# -----------------------------------------------------------------------------

${FIAT_BUILD}/target/${FIAT_BOARD}/%.o : %.c
	@${GCC_PREFIX}gcc $(patsubst %, -I %, ${INCLUDES}) ${GCC_PATHS} ${GCC_FLAGS} -c -o ${@} ${<}
${FIAT_BUILD}/target/${FIAT_BOARD}/%.o : %.s
	@${GCC_PREFIX}gcc $(patsubst %, -I %, ${INCLUDES}) ${GCC_PATHS} ${GCC_FLAGS} -c -o ${@} ${<}
${FIAT_BUILD}/target/${FIAT_BOARD}/%.o : %.S
	@${GCC_PREFIX}gcc $(patsubst %, -I %, ${INCLUDES}) ${GCC_PATHS} ${GCC_FLAGS} -c -o ${@} ${<}

${FIAT_BUILD}/target/${FIAT_BOARD}/%.elf ${FIAT_BUILD}/target/${FIAT_BOARD}/%.map : ${OBJECTS}
	@${GCC_PREFIX}gcc $(patsubst %, -I %, ${INCLUDES}) ${GCC_PATHS} ${GCC_FLAGS} -Wl,-Map="${FIAT_BUILD}/target/${FIAT_BOARD}/${*}.map" -o ${FIAT_BUILD}/target/${FIAT_BOARD}/${*}.elf ${^} ${GCC_LIBS}
${FIAT_BUILD}/target/${FIAT_BOARD}/%.bin                                          : ${FIAT_BUILD}/target/${FIAT_BOARD}/%.elf
	@${GCC_PREFIX}objcopy ${OBJCOPY_FLAGS} --output-target="binary" ${<} ${@}
${FIAT_BUILD}/target/${FIAT_BOARD}/%.hex                                          : ${FIAT_BUILD}/target/${FIAT_BOARD}/%.elf
	@${GCC_PREFIX}objcopy ${OBJCOPY_FLAGS} --output-target="ihex"   ${<} ${@}

# -----------------------------------------------------------------------------

program-jlink :
	@${FIAT_HOME}/src/fiat/target/board/imp/${FIAT_BOARD}/script/program-jlink.sh $(filter %.hex, ${TARGETS})

# =============================================================================
